---
title: "BISG Mapping Police Violence"
author: "John A. Curiel"
date: "2024-02-22"
output: html_document
---
# Mapping Police Violence outline 

The goal of this module is to learn how to implement Bayesian Improved Surname Geocoding (BISG) imputation of race, in addition to validation exercises. We shall impute race employing Mapping Police Violence data, which in part records race and location.^[https://mappingpoliceviolence.org/] With these data, we shall cover the general best practices and learn the general error rate. 

## Checking and installing relevant packages

The first step when employing BISG is to install the relevant packages. For BISG, we specifically want the "wru" package ("Who are you?") by Imai and Khanna (2016) in addition to zipWRUext2 by Clark, Curiel and Steelman (2021) for ease of use. Note, because zipWRUext2 relies in part upon the surname dictionary provided by Imai and Khanna's version 0.1-12, the "special install" section in the block of code below shall ensure that the appropriate version is installed, thereby preventing issues with imputation later on. 

```{r setup, include=TRUE, results='asis'}
### check for packages 
pkg <- c("stringr","stringi","tidyverse","foreign","conflicted","data.table","raster","gtools","rgdal",
         "sp","redist","reshape2","ggplot2","ggpubr","rstudioapi","rgeos","scales","splitstackshape",
         "tidyr","devtools", "sf", "geojsonio")

for (i in pkg){
  print(i)
  if(require(i, character.only=TRUE)){
    print(paste(i, "is loaded correctly"))
  } else{
    print(paste("trying to install", i))
    install.packages(i)
    if(require(i, character.only=TRUE)){
      print(paste(i, "installed and loaded"))
    } else{
      stop(paste("could not install", i))
    }
  }
}
###special install for wru 

check_wru <- system.file("wru")

require(devtools)
if(require("wru", character.only=TRUE) & as.numeric(substr(packageVersion("wru"),1,3)) < 1 ){
  print(paste("WRU", "is loaded correctly"))
} else{
  print(paste("trying to install wru"))
  if(check_wru!=""){
    detach("package:wru", unload=TRUE)
    print("Detached another installed version of wru")
  }
  install_version("wru", version = "0.1-12", repos = "http://cran.us.r-project.org")
  ### note: if asked to update other versions, just press 3 to skip
  if(require(i, character.only=TRUE)){
    print(paste("wru installed and loaded"))
  } else{
    stop(paste("could not install wru"))
  }
  
}

####pkgs to be used 
library(foreign)
library(tidyverse)
library(dplyr)
library(sp) # basic spatial object handling
library(raster) # raster (pixel) object handling
library(rgdal) # shapefile access
library(rgeos) # geometry operations
library(reshape2)
library(stringi) # text processing 
library(stringr) # text processing 
library(splitstackshape)
library(data.table)
library(ggplot2)
library(scales)
library(conflicted)
library(geojsonio)
library(sf)
##install the arealOverlap pkg 
#devtools::install_github("https://github.com/jcuriel-unc/arealOverlap2",subdir="arealOverlap")
#library(arealOverlap)
library(wru)
##install the zipWRUext2 pkg 
#devtools::install_github("https://github.com/jcuriel-unc/zipWRUext",subdir="zipWRUext2")
library(zipWRUext2)
## set directory 
data_wd <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(data_wd)
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

```

## Loading in the proper data

The next step is to read in and clean the data. These data were downloaded from the Mapping Police Violence site on October 24, 2022 by Logan Harrah as part of his Senior Capstone Project presented at the Western Political Science Conference on April 7, 2023 titled "I'm Armed, Don't Shoot!" 

We first start by reading in the data "mpv_data.csv" and proceed to clean two fields of interest. First, we clean the field noting the "weapon" reportedly on the person of interest. This, we change to "alleged_weapon."  


```{r data of interest}
### read in the data 
police <- read.csv("data/mpv_df.csv")
## change name for weapon field 
colnames(police)[colnames(police)=="Alleged.Weapon..Source..WaPo.and.Review.of.Cases.Not.Included.in.WaPo.Database."] <-
  "alleged_weapon"
## change weapon field to lower case 
police$alleged_weapon <- str_to_lower(police$alleged_weapon)
```

Next, we proceed to clean the name field, which we will need for the "Surname" portion of BISG. Note, we find that there are 226 names withheld. Further, it appears that the name fields were not properly cleaned. Additionally, the police withheld a number of names. We will need to ensure proper cleaned names for the purpose of the surname aspect of BISG.  

```{r checking name fields, results='asis',include=TRUE}

head(police[,1:5], 10)

```

Therefore, we will clean the names in three stages. First, we shall first note in a dummy field titled "name_withheld" whether a name is absent, coded 1 if true, 0 otherwise. We then shall replace the name with the generic "Noah A Smith", which according to multiple surname and first name dictionaries approximately matches the naive prior employed across multiple BISG associated packages. Such information will be useful later once we seek to identify error rates. Thankfully, it appears that the police withheld only 226 names out of 9,942 observations. 


```{r name checking, include=TRUE,results='asis'}
### we will want a cleaner version to split of full_name 
police$full_name <- police$Victim.s.Full.name

### note: some names are withheld by police 
print(length(which(police$full_name=="Name withheld by police"))) ### note: 226 names withheld

# we will now want to create a dummy variable for later, since these will be information where we rely primarily on the geographic component. 
police$name_withheld <- 0
police$name_withheld[police$full_name=="Name withheld by police"] <- 1
sum(police$name_withheld)

### We will now proceed to choose a name that acts as a naive prior, "Smith". Note, the "Noah A" portion was likewise found to have a naive distribution as validated against the python library, zrp -- Zestai Race Predictor.  
police$full_name[police$full_name=="Name withheld by police"] <- "Noah A Smith"
#table(police$full_name)
length(unique(police$full_name)) # 9662
```

We will next need to clean and split the full name into multiple fields. We will want to be careful, as we only need the surname for today, though it is possible to use first and middle names as well with more advanced packages. Additionally, we saw earlier names such as "Flowers II." Where the suffix is not helpful in imputing race, splitting names might result in losing the surname and only grabbing the suffix. Therefore, we will likewise need to clean the suffix characters out of the full name prior to splitting. The first step is to remove punctuation, for the purpose of ease of cleaning. Next, proceed to replace the suffixes. Next, find the length of the name field, followed by the removal of white space. Commented out is a command to print out a subset of data with names longer than 3 sections. When glancing over the data, there appears to be no indication of any suffix that might thwart the BISG process.  

```{r suffix cleaning, include=TRUE,results='asis'}
#### splitting names and pre-cleaning #####

### get rid of punctuation 
police$full_name <- gsub("[[:punct:]]", " ", police$full_name ) 

## get rid of various suffixes 
police$full_name <- str_replace_all(police$full_name, " IV", "")
police$full_name <- str_replace_all(police$full_name, " III", "")
police$full_name <- str_replace_all(police$full_name, " II", "")
police$full_name <- str_replace_all(police$full_name, " Jr", "")
police$full_name <- str_replace_all(police$full_name, " Sr", "")

## create a length field for name; we want to look at those more than 3. 
police$name_length <- lengths(gregexpr("[A-z]\\W+", police$full_name)) + 1L

## remove extra white spaces 
police$full_name <- gsub("\\s+"," ",police$full_name)
police$full_name <- trimws(police$full_name)

### print out long names; glance over if any obvious mistakes 
#long_names <- subset(police, name_length > 3)
#sort(unique(long_names$full_name)) 

```

With the suffix values cleaned out, it is now possible to split the names into individual fields. The commands shall string split the data into list objects, grabbing the first value for the first name, last for the last name, and the second from the last for the middle name. Note, the middle name might grab the first name where the length is less than 3. Therefore, these are coded as "A" where length is equal to 2. Note, there are some names far longer. We will not account for this for now, since even with BISG that employs all parts of the name, little predictive value is gained from middle names.  


```{r splitting names,include=TRUE,results='asis'}
### now work on splitting names 
police$first_name <- sapply(strsplit(police$full_name, " "), `[`, 1) # for first name, we are grabbing the portion that is first before the space split. 
# we can likewise see this by going with the "Noah A Smith" example 
sapply(strsplit("Noah A Smith", " "), `[`, 1) #see, pulled Noah as the first name as the first element of a list. 

police$last_name <- sub(".* ", "", police$full_name) # for last name, we are pulling the last portion of the full name 
sub(".* ", "", "Noah A Smith") ## we will see what it does to name here; note, the name "Smith" is grabbed. 
## now, let's check what happens if no middle name? 
sub(".* ", "", "Noah Smith") # still Smith. Therefore, all should be good to go for the surname of interest. 

#police$name_length <- lengths(gregexpr("[A-z]\\W+", police$full_name)) + 1L
summary(police$name_length) #looks like most do not have middle names ; 
### assign middle name of "A" based on if 2 length
police$middle_name <- sapply( strsplit(police$full_name, " "), tail, 1)
police$middle_name[police$name_length==2] <- "A"

head(police$last_name)

```

## The Geographic component 

When employing BISG, we want the geographic information to be preferably at the level of Census Block Group, which is the most precise data that is also updated via 5-year American Community Survey (ACS). In the event that we do not have geocoding, we can rely upon ZIP codes. Where ZIP codes are not an option, finally county. 

```{r pressure, echo=FALSE}



```

